<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>iPRD Host</title>
  <style>
    :root {
      --bg: #F8FAFC;
      --text: #1E293B;
      --muted: #475569;
      --border: #E2E8F0;
      --panel: #FFFFFF;
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      height: 100%;
    }
    body { display: flex; flex-direction: column; }
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
      z-index: 20;
      padding: 14px 20px;
    }
    h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 700;
    }
    .tip {
      margin-top: 6px;
      font-size: 13px;
      color: var(--muted);
    }
    main {
      margin-top: 76px;
      margin-bottom: 54px;
      padding: 16px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      height: calc(100vh - 130px);
      overflow: hidden;
    }
    .col {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      overflow: auto;
    }
    .block {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      background: #fff;
    }
    .label {
      font-size: 12px;
      text-transform: uppercase;
      color: var(--muted);
      letter-spacing: 0.05em;
      margin-bottom: 6px;
      font-weight: 600;
    }
    input[type="text"], input[type="password"], textarea {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      font-size: 14px;
      background: #fff;
      color: var(--text);
    }
    textarea {
      min-height: 150px;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    button {
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      border-radius: 10px;
      padding: 10px 12px;
      font-weight: 600;
      cursor: pointer;
    }
    button.primary {
      background: #0f172a;
      color: #fff;
      border-color: #0f172a;
    }
    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }
    .status {
      font-size: 13px;
      color: var(--muted);
      white-space: pre-wrap;
    }
    .cards {
      display: grid;
      gap: 10px;
    }
    .card {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      background: #fff;
    }
    .card a {
      color: #0f172a;
      font-weight: 700;
      text-decoration: none;
    }
    .card small {
      color: var(--muted);
      display: block;
      margin-top: 3px;
    }
    iframe {
      width: 100%;
      min-height: 420px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
    }
    footer {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: 54px;
      border-top: 1px solid var(--border);
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      color: var(--muted);
    }
    @media (max-width: 920px) {
      main {
        grid-template-columns: 1fr;
        height: auto;
        min-height: calc(100vh - 130px);
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Interactive iPRD</h1>
    <div class="tip">Tip: Use Canvas Preview to interact.</div>
  </header>

  <main>
    <section class="col">
      <div class="block">
        <div class="label">Upload PRD HTML</div>
        <input id="htmlFile" type="file" accept=".html,text/html" />
      </div>

      <div class="block">
        <div class="label">Or Paste HTML</div>
        <textarea id="htmlInput" placeholder="Paste generated iPRD index.html here"></textarea>
      </div>

      <div class="block row">
        <div>
          <div class="label">Page Slug</div>
          <input id="slug" type="text" placeholder="AI-index" />
        </div>
        <div>
          <div class="label">Display Title</div>
          <input id="title" type="text" placeholder="AI Features" />
        </div>
      </div>

      <div class="block">
        <div class="label">GitHub Token (stored in browser)</div>
        <input id="token" type="password" placeholder="Fine-grained PAT with Contents+Actions write" />
        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
          <button id="saveToken">Save Token</button>
          <button id="clearToken">Clear Token</button>
          <button id="previewBtn">Preview HTML</button>
          <button id="deployBtn" class="primary">Deploy as GitHub Page</button>
        </div>
      </div>

      <div class="block">
        <div class="label">Deployment Status</div>
        <div class="status" id="status">Waiting for input.</div>
      </div>

      <div class="block">
        <div class="label">Hosted PRDs</div>
        <div class="cards" id="cards"></div>
      </div>
    </section>

    <section class="col">
      <div class="label">Preview</div>
      <iframe id="preview"></iframe>
    </section>
  </main>

  <footer>Made with ❤️ & ☕ by RBX Labs</footer>

  <script>
    const REPO_OWNER = "RBX-Labs";
    const REPO_NAME = "iPRD";
    const WORKFLOW_FILE = "publish-iprd.yml";

    const fileInput = document.getElementById("htmlFile");
    const htmlInput = document.getElementById("htmlInput");
    const slugInput = document.getElementById("slug");
    const titleInput = document.getElementById("title");
    const tokenInput = document.getElementById("token");
    const statusBox = document.getElementById("status");
    const previewFrame = document.getElementById("preview");
    const cards = document.getElementById("cards");

    function setStatus(msg) {
      statusBox.textContent = msg;
    }

    function slugify(raw) {
      return raw
        .trim()
        .replace(/\.html?$/i, "")
        .replace(/\s+/g, "-")
        .replace(/[^A-Za-z0-9-]/g, "")
        .replace(/-+/g, "-");
    }

    function toB64(str) {
      return btoa(unescape(encodeURIComponent(str)));
    }

    function getHtml() {
      return htmlInput.value.trim();
    }

    async function loadRegistry() {
      try {
        const res = await fetch("./iprds/index.json", { cache: "no-store" });
        if (!res.ok) throw new Error("registry not found");
        const data = await res.json();
        cards.innerHTML = "";
        (data.items || []).forEach((item) => {
          const div = document.createElement("div");
          div.className = "card";
          const left = document.createElement("div");
          const a = document.createElement("a");
          a.href = item.path;
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.textContent = item.title || item.slug;
          const meta = document.createElement("small");
          meta.textContent = item.path;
          left.appendChild(a);
          left.appendChild(meta);
          const right = document.createElement("small");
          right.textContent = item.updated_at || "";
          div.appendChild(left);
          div.appendChild(right);
          cards.appendChild(div);
        });
      } catch (err) {
        cards.innerHTML = "<div class=\"status\">No registry found yet.</div>";
      }
    }

    fileInput.addEventListener("change", async (event) => {
      const file = event.target.files && event.target.files[0];
      if (!file) return;
      const text = await file.text();
      htmlInput.value = text;
      if (!slugInput.value) slugInput.value = slugify(file.name);
      if (!titleInput.value) titleInput.value = slugInput.value;
      setStatus("HTML loaded from file.");
    });

    document.getElementById("previewBtn").addEventListener("click", () => {
      const html = getHtml();
      if (!html) {
        setStatus("Paste or upload HTML first.");
        return;
      }
      previewFrame.srcdoc = html;
      setStatus("Preview rendered.");
    });

    document.getElementById("saveToken").addEventListener("click", () => {
      localStorage.setItem("iprd_gh_token", tokenInput.value.trim());
      setStatus("Token saved in localStorage.");
    });

    document.getElementById("clearToken").addEventListener("click", () => {
      localStorage.removeItem("iprd_gh_token");
      tokenInput.value = "";
      setStatus("Token cleared.");
    });

    document.getElementById("deployBtn").addEventListener("click", async () => {
      const html = getHtml();
      const slug = slugify(slugInput.value || titleInput.value || "");
      const title = (titleInput.value || slug).trim();
      const token = tokenInput.value.trim() || localStorage.getItem("iprd_gh_token") || "";

      if (!html) {
        setStatus("Missing HTML content.");
        return;
      }
      if (!slug) {
        setStatus("Missing valid slug.");
        return;
      }
      if (!token) {
        setStatus("Missing GitHub token.");
        return;
      }

      setStatus("Dispatching GitHub workflow...");
      const endpoint = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/actions/workflows/${WORKFLOW_FILE}/dispatches`;
      const payload = {
        ref: "main",
        inputs: {
          slug,
          title,
          html_base64: toB64(html)
        }
      };

      try {
        const res = await fetch(endpoint, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Accept": "application/vnd.github+json",
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const txt = await res.text();
          throw new Error(`Dispatch failed (${res.status}): ${txt}`);
        }

        setStatus(
          `Workflow started for /${slug}.\n` +
          `Check Actions tab and then open https://rbx-labs.github.io/iPRD/${slug}`
        );
      } catch (err) {
        setStatus(String(err.message || err));
      }
    });

    tokenInput.value = localStorage.getItem("iprd_gh_token") || "";
    loadRegistry();
  </script>
</body>
</html>
